<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>2D Ferry Simulator ‚Äî Buenos Aires ‚Üî Colonia</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<style>
  html, body { height:100%; margin:0; background:#cfe9ff; }
  canvas { display:block; }
  /* Quiz popup */
  .quiz-modal {
    position: fixed; inset: 0;
    display: none; place-items: center;
    background: rgba(0,0,0,.45); z-index: 20;
    font-family: system-ui, Arial;
  }
  .quiz-card { width:min(92vw,640px); background:#fff; border-radius:16px; box-shadow:0 8px 30px rgba(0,0,0,.25); padding:18px; }
  .quiz-q { font-weight:700; font-size:18px; margin-bottom:10px; }
  .quiz-opt { display:block; width:100%; text-align:left; margin:6px 0; padding:10px 12px; border-radius:10px; border:1px solid #ccc; background:#f9fbff; cursor:pointer; }
  .quiz-opt:hover { filter:brightness(0.98); }
  .quiz-footer { display:flex; justify-content:space-between; align-items:center; margin-top:8px; }
  .quiz-close { background:#0ea5e9; color:#fff; border:none; border-radius:8px; padding:8px 12px; cursor:pointer; }
  .hud {
    position:fixed; left:12px; top:12px; background:rgba(0,0,0,.45);
    color:#fff; font-family:system-ui,Arial; padding:8px 12px; border-radius:10px; z-index:10;
  }
  .hud b { font-size:16px; display:block; }
  .hud .pill { background:#0ea5e9; border-radius:999px; padding:2px 8px; font-size:12px; }
  .hud button { margin-top:6px; padding:6px 10px; border:none; border-radius:8px; background:#0006; color:#fff; cursor:pointer; }
  .touch-ctrls {
    position:fixed; right:12px; bottom:12px; display:grid; grid-template-columns:64px 64px; gap:10px; z-index:10;
  }
  .ctrl { width:64px; height:64px; border-radius:50%; background:#0006; color:#fff; display:grid; place-items:center; font-weight:700; border:1px solid #fff3; cursor:pointer; user-select:none; touch-action:none; }
  .ctrl.wide { grid-column:span 2; border-radius:16px; width:138px; }
  .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:18px; background:#0ea5e9; color:#fff; padding:10px 14px; border-radius:10px; font-family:system-ui; display:none; z-index:30; }
</style>
<script src="https://cdn.jsdelivr.net/npm/phaser@3.80.0/dist/phaser.min.js"></script>
</head>
<body>

<div class="hud" id="hud">
  <b>Ferry Simulator</b>
  <div><span class="pill" id="dirPill">BA ‚Üí Colonia</span></div>
  <div>‚è± <span id="timeLeft">05:00</span> | ‚úÖ <span id="answered">0</span>/25</div>
  <div>üìç Remaining: <span id="remaining">25</span></div>
  <button id="flipDir">Swap Direction</button>
</div>

<div class="touch-ctrls" id="touchCtrls">
  <div class="ctrl" data-act="left">‚ü≤</div>
  <div class="ctrl" data-act="right">‚ü≥</div>
  <div class="ctrl wide" data-act="thrust">THRUST</div>
  <div class="ctrl wide" data-act="reverse">REVERSE</div>
</div>

<div class="quiz-modal" id="quizModal">
  <div class="quiz-card">
    <div class="quiz-q" id="quizQuestion"></div>
    <button class="quiz-opt" id="opt0"></button>
    <button class="quiz-opt" id="opt1"></button>
    <button class="quiz-opt" id="opt2"></button>
    <div class="quiz-footer">
      <div id="quizFeedback" style="visibility:hidden;">Correcto!</div>
      <button class="quiz-close" id="quizClose">Continuar</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
(() => {
const WORLD_W = 3200, WORLD_H = 2000, TIME_LIMIT = 300, CP_COUNT = 25;
let dirBAtoColonia = true;
let asked=0, remain=CP_COUNT, timeLeft=TIME_LIMIT;
let player, checkpoints, finishZone, water, minimapArrow;
let startTime, modalOpen=false, currentCP=null, touch={left:false,right:false,thrust:false,reverse:false};

const QUESTIONS=[
{q:"¬øQu√© r√≠o separa Buenos Aires y Colonia?",options:["R√≠o Paran√°","R√≠o de la Plata","R√≠o Uruguay"],correct:1},
{q:"¬øQu√© pa√≠s es Colonia del Sacramento?",options:["Argentina","Uruguay","Paraguay"],correct:1},
{q:"¬øCu√°l es la capital de Argentina?",options:["Rosario","Buenos Aires","C√≥rdoba"],correct:1},
{q:"¬øCu√°l es la capital de Uruguay?",options:["Punta del Este","Colonia","Montevideo"],correct:2},
{q:"¬øQu√© hacer en neblina?",options:["Aumentar velocidad","Reducir y usar bocina","Ignorar"],correct:1},
{q:"El faro de Colonia sirve para:",options:["Decoraci√≥n","Navegaci√≥n","Pesca"],correct:1},
{q:"Babor es:",options:["Izquierda","Derecha","Atr√°s"],correct:0},
{q:"Estribor es:",options:["Izquierda","Derecha","Abajo"],correct:1},
{q:"Popa es:",options:["Delantera","Trasera","Derecha"],correct:1},
{q:"Proa es:",options:["Delantera","Trasera","Izquierda"],correct:0},
{q:"El calado es:",options:["Profundidad sumergida","Altura","Anchura"],correct:0},
{q:"La eslora es:",options:["Ancho","Largo","Altura"],correct:1},
{q:"La manga es:",options:["Ancho","Largo","Altura"],correct:0},
{q:"Velocidad segura en puerto:",options:["Alta","Media","Baja"],correct:2},
{q:"Qu√© hacer si el GPS falla:",options:["Usar referencias visuales","Nada","Apagar motor"],correct:0},
{q:"Colonia es famosa por su:",options:["Casco hist√≥rico","Volcanes","Desierto"],correct:0},
{q:"Buenos Aires se ubica en:",options:["Margen oeste del R√≠o de la Plata","Oc√©ano Atl√°ntico","R√≠o Uruguay"],correct:0},
{q:"Los vientos pamperos son:",options:["Del sudoeste","Del norte","Del este"],correct:0},
{q:"La derrota es:",options:["Ruta planeada","Ancla","Altura"],correct:0},
{q:"Un canal dragado es:",options:["Profundo mantenido","Peligroso","Cerrado"],correct:0},
{q:"Navegar de d√≠a facilita:",options:["Ver ayudas","Nada","Aumenta riesgos"],correct:0},
{q:"Una sonda mide:",options:["Profundidad","Temperatura","Velocidad"],correct:0},
{q:"AIS sirve para:",options:["Identificar tr√°fico","Ver TV","Cocinar"],correct:0},
{q:"Boyas cardinales indican:",options:["Zonas seguras","Playas","Puertos"],correct:0},
{q:"Un remolcador sirve para:",options:["Maniobras","Pesca","Turismo"],correct:0},
{q:"Qu√© hacer con hombre al agua:",options:["Maniobra inmediata","Seguir","Ignorar"],correct:0},
{q:"El tim√≥n controla:",options:["Direcci√≥n","Propulsi√≥n","Iluminaci√≥n"],correct:0},
{q:"La estela es:",options:["Rastro de espuma","Humo","Nada"],correct:0},
{q:"Si hay corriente en contra:",options:["Avanz√°s m√°s lento","M√°s r√°pido","Igual"],correct:0},
{q:"El faro ayuda a:",options:["Navegaci√≥n nocturna","Nada","Pesca"],correct:0},
{q:"En Colonia ver√°s:",options:["Murallas y faro","Volcanes","Desierto"],correct:0},
{q:"Puerto principal de BA:",options:["Puerto Nuevo","Rosario","Mar del Plata"],correct:0},
{q:"Viento fuerte transversal provoca:",options:["Deriva","Nada","Aceleraci√≥n"],correct:0},
{q:"Las cartas n√°uticas muestran:",options:["Profundidades y boyas","Clima","Restaurantes"],correct:0},
{q:"Si ves otra embarcaci√≥n de frente:",options:["Desviarse a estribor","Seguir igual","Acelerar"],correct:0},
{q:"Una boya roja a estribor indica:",options:["Canal a estribor","A babor","No pasa"],correct:0},
{q:"Los contenedores del puerto se usan para:",options:["Carga","Decoraci√≥n","Combustible"],correct:0},
{q:"El faro de BA est√° en:",options:["Costanera Sur","Montevideo","C√≥rdoba"],correct:0},
{q:"Qu√© indica bandera roja:",options:["Precauci√≥n","Sin viento","Todo bien"],correct:0},
{q:"Dragado mantiene:",options:["Canales navegables","Playas","Muelles"],correct:0},
{q:"Viento Pampero es:",options:["Fr√≠o y seco","C√°lido","H√∫medo"],correct:0},
{q:"Colonia est√° al:",options:["Este","Oeste","Norte"],correct:0},
{q:"BA est√° al:",options:["Oeste","Este","Sur"],correct:0},
{q:"Prioridad en canales angostos:",options:["Naves grandes","Peque√±as","Velero"],correct:0},
{q:"La popa tiene h√©lices?",options:["S√≠","No","Depende"],correct:0},
{q:"Faro emite:",options:["Luz","Sonido","Humo"],correct:0},
{q:"Navegar el√©ctrico implica:",options:["Sin emisiones","M√°s ruido","M√°s humo"],correct:0},
{q:"Ferry el√©ctrico usa:",options:["Bater√≠as","Nafta","Gasoil"],correct:0},
{q:"Energ√≠a limpia significa:",options:["Menos emisiones","M√°s gasto","Ninguna"],correct:0},
{q:"Pintura antifouling sirve para:",options:["Evitar incrustaciones","Brillo","Color"],correct:0}
];

function pickN(arr,n){const c=[...arr];for(let i=c.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[c[i],c[j]]=[c[j],c[i]];}return c.slice(0,n);}
let QUESTIONS_RUN=pickN(QUESTIONS,50), usedQ=new Set();

function showToast(msg,ms=1500){const t=document.getElementById("toast");t.textContent=msg;t.style.display="block";clearTimeout(t._tid);t._tid=setTimeout(()=>t.style.display="none",ms);}

const config={
  type:Phaser.AUTO, backgroundColor:"#aee3ff",
  scale:{mode:Phaser.Scale.RESIZE,autoCenter:Phaser.Scale.CENTER_BOTH,width:window.innerWidth,height:window.innerHeight},
  physics:{default:"arcade",arcade:{gravity:{y:0},debug:false}},
  scene:{preload,create,update}
};
let game=new Phaser.Game(config);

// <<< CHANGED SECTION >>>
// The preload function now loads external image files from the 'assets' folder
// instead of generating graphics with code.
function preload(){
  this.load.image('ferry', 'assets/ferry.png');
  this.load.image('cp', 'assets/checkpoint.png');
  this.load.image('finish', 'assets/finish_flag.png');
  this.load.image('arrow', 'assets/arrow.png');
  this.load.image('water', 'assets/cartoon_water.png');
  this.load.image('coast_ba', 'assets/buenos_aires_coast.png');
  this.load.image('coast_colonia', 'assets/colonia_coast.png');
}
// <<< END CHANGED SECTION >>>


function create(){
  const scene=this;
  scene.cameras.main.setBounds(0,0,WORLD_W,WORLD_H);
  scene.physics.world.setBounds(0,0,WORLD_W,WORLD_H);

  // <<< CHANGED SECTION >>>
  // We add the tileable water sprite and the large coast images.
  // The 'drawCoasts' function has been removed entirely.
  water=scene.add.tileSprite(WORLD_W/2,WORLD_H/2,WORLD_W,WORLD_H,"water");
  scene.add.image(0, WORLD_H / 2, 'coast_ba').setOrigin(0, 0.5).setDepth(2);
  scene.add.image(WORLD_W, WORLD_H / 2, 'coast_colonia').setOrigin(1, 0.5).setDepth(2);
  // <<< END CHANGED SECTION >>>
  
  const start=dirBAtoColonia?{x:350,y:WORLD_H*0.55}:{x:WORLD_W-350,y:WORLD_H*0.45};
  const finish=dirBAtoColonia?{x:WORLD_W-350,y:WORLD_H*0.45}:{x:350,y:WORLD_H*0.55};

  player=scene.physics.add.image(start.x,start.y,"ferry").setCollideWorldBounds(true);
  player.setDamping(true).setDrag(0.98).setMaxVelocity(220);
  // Adjust the physics body size to better match your new ferry sprite
  player.setSize(80, 30); 
  scene.cameras.main.startFollow(player,true,0.1,0.1);

  finishZone=scene.physics.add.staticGroup();
  finishZone.create(finish.x,finish.y,"finish").setScale(1.5).refreshBody();

  checkpoints=scene.physics.add.group();
  const cps=generateCPs(start,finish,CP_COUNT);
  cps.forEach(p=>{const c=checkpoints.create(p.x,p.y,"cp");c.setCircle(16);c.collected=false;});
  scene.physics.add.overlap(player,checkpoints,onCP,null,scene);
  scene.physics.add.overlap(player,finishZone,onFinish,null,scene);

  cursors=scene.input.keyboard.createCursorKeys();
  keys=scene.input.keyboard.addKeys({W:87,A:65,S:83,D:68,SHIFT:16});

  setupQuiz(scene);
  setupHUD(scene);
  minimapArrow=scene.add.image(0,0,"arrow").setScrollFactor(0).setDepth(10).setAlpha(0.85);
  startTime=scene.time.now;
}

function update(t,dt){
  water.tilePositionX = player.body.velocity.x * 0.05 + 0.04 * dt;
  water.tilePositionY = player.body.velocity.y * 0.05 + 0.02 * dt;
  if(modalOpen){player.setAcceleration(0);return;}
  const turnL=cursors.left.isDown||keys.A.isDown||touch.left;
  const turnR=cursors.right.isDown||keys.D.isDown||touch.right;
  const thrust=cursors.up.isDown||keys.W.isDown||touch.thrust;
  const reverse=cursors.down.isDown||keys.S.isDown||keys.SHIFT.isDown||touch.reverse;
  player.setAngularVelocity(turnL?-160:turnR?160:0);
  const a=player.rotation,ACC=220;
  if(thrust)player.setAcceleration(Math.cos(a)*ACC,Math.sin(a)*ACC);
  else if(reverse)player.setAcceleration(Math.cos(a)*-ACC*0.6,Math.sin(a)*-ACC*0.6);
  else player.setAcceleration(0);
  timeLeft=Math.max(0,TIME_LIMIT-Math.floor((t-startTime)/1000));
  updateHUDTimer();
  if(timeLeft<=0){endScreen(false);return;}
  updateArrow(this);
}

function generateCPs(start,finish,n){
  const arr=[],minX=Math.min(start.x,finish.x)+200,maxX=Math.max(start.x,finish.x)-200;
  for(let i=0;i<n;i++){const t=i/(n-1),x=Phaser.Math.Linear(minX,maxX,t)+Math.sin(t*Math.PI*2.2)*220,y=Phaser.Math.Linear(400,1600,Math.random());arr.push({x,y});}
  return arr;
}

function onCP(p,cp){if(cp.collected)return;cp.collected=true;currentCP=cp;openQuiz();}
function onFinish(){if(remain>0)return;endScreen(true);}

function setupQuiz(scene){
  const modal=document.getElementById("quizModal"),q=document.getElementById("quizQuestion"),opts=[0,1,2].map(i=>document.getElementById("opt"+i)),fb=document.getElementById("quizFeedback"),close=document.getElementById("quizClose");
  window.openQuiz=function(){
    const qi=[...Array(QUESTIONS_RUN.length).keys()].find(i=>!usedQ.has(i))??Math.floor(Math.random()*QUESTIONS_RUN.length);
    usedQ.add(qi);const Q=QUESTIONS_RUN[qi];q.textContent=Q.q;fb.style.visibility="hidden";
    const order=[0,1,2].sort(()=>Math.random()-0.5);
    opts.forEach((b,i)=>{b.textContent=Q.options[order[i]];b.dataset.c=(order[i]===Q.correct)?1:0;b.disabled=false;b.style.background=""; b.onclick=()=>{const ok=b.dataset.c=="1";b.style.background=ok?"#d1fae5":"#fee2e2";fb.textContent=ok?"Correcto!":"Incorrecto";fb.style.visibility="visible";opts.forEach(x=>x.disabled=true);asked++;remain--;updateHUD();if(currentCP){currentCP.destroy();currentCP=null;}};});
    modal.style.display="grid";modalOpen=true;
  };
  close.onclick=()=>{modal.style.display="none";modalOpen=false;};
}

function setupHUD(scene){
  document.getElementById("flipDir").onclick=()=>{dirBAtoColonia=!dirBAtoColonia;document.getElementById("dirPill").textContent=dirBAtoColonia?"BA ‚Üí Colonia":"Colonia ‚Üí BA";resetGame();};
  const ctrls=document.getElementById("touchCtrls");
  ctrls.querySelectorAll(".ctrl").forEach(el=>{
    const act=el.dataset.act;const set=v=>touch[act]=v;
    el.addEventListener("pointerdown",e=>{e.preventDefault();set(true);});
    el.addEventListener("pointerup",e=>{e.preventDefault();set(false);});
    el.addEventListener("pointerleave",e=>{set(false);});
  });
}

function updateHUD(){document.getElementById("answered").textContent=asked;document.getElementById("remaining").textContent=remain;}
function updateHUDTimer(){const m=Math.floor(timeLeft/60),s=timeLeft%60;document.getElementById("timeLeft").textContent=`${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;}

function endScreen(win){
  modalOpen=true;
  const msg=win?(dirBAtoColonia?"¬°Llegaste a Colonia!":"¬°Llegaste a Buenos Aires!"):"‚è≥ Tiempo agotado";
  const sub=win?`Respondiste ${asked} preguntas.`:`Te faltaron ${remain} checkpoints.`;
  showToast(msg+" "+sub,4000);
  setTimeout(()=>resetGame(),4000);
}

function resetGame(){game.destroy(true);asked=0;remain=CP_COUNT;timeLeft=TIME_LIMIT;usedQ.clear();QUESTIONS_RUN=pickN(QUESTIONS,50);modalOpen=false;game=new Phaser.Game(config);updateHUD();updateHUDTimer();}

function updateArrow(scene){
  const cam=scene.cameras.main;const f=dirBAtoColonia?{x:WORLD_W-350,y:WORLD_H*0.45}:{x:350,y:WORLD_H*0.55};
  const dx=f.x-player.x,dy=f.y-player.y,ang=Math.atan2(dy,dx),r=Math.min(cam.width,cam.height)/2-24;
  minimapArrow.setPosition(cam.width/2+Math.cos(ang)*r*0.85,cam.height/2+Math.sin(ang)*r*0.85);minimapArrow.setRotation(ang);
}
})();
</script>
</body>
</html>